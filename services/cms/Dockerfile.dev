# FROM drupal:9.5.7-php8.1-fpm-alpine3.17
# FROM drupal:9.5.9-php8.1-apache-bullseye
FROM drupal:9.5.10-php8.1-apache-bullseye
# FROM drupal:10.0.9-php8.1-apache-bullseye

ARG ROOT
ARG ENV

# Install build dependencies
# RUN apk add --no-cache bash
# RUN apk add --no-cache git
# RUN apk add --no-cache mysql-client
RUN apt-get update && apt-get install -y \
    unzip \
    default-mysql-client \
    rsync \
    && rm -rf /var/lib/apt/lists/*

# Install modules
RUN touch /.dockerenv
RUN composer config repositories.1 composer https://asset-packagist.org && \
    composer config --json extra.installer-paths.web/libraries/\{\$name\} '["type:drupal-library", "type:bower-asset", "type:npm-asset"]' && \
    composer config --json extra.installer-types '["bower-asset", "npm-asset"]' && \
    composer config --no-plugins allow-plugins.oomphinc/composer-installers-extender true

RUN composer require \
    oomphinc/composer-installers-extender \
    npm-asset/select2 \
    drush/drush:^11.5.1 \
    drupal/admin_toolbar:^3.3.0 \
    drupal/backup_migrate:^5.0.3 \
    drupal/coder:^8.3.16 \
    drupal/coffee:^1.3 \
    drupal/devel:^5.1.1 \
    drupal/gin_toolbar:^1.0@RC \
    drupal/gin:^3.0@RC \
    drupal/pathauto:^1.11 \
    drupal/smtp:^1.2 \
    drupal/file_delete:^2.0 \
    # drupal/content_type_clone:^1.0 \
    drupal/drush_language:^1.0@RC \
    drupal/realistic_dummy_content:^3.1 \
    drupal/easy_breadcrumb:^2.0 \
    drupal/language_switcher_extended:^1.1 \
    drupal/paragraphs:^1.15 \
    drupal/svg_image:^3.0 \
    drupal/views_bulk_operations:^4.2.3 \
    drupal/fancy_file_delete:^2.0 \
    drupal/file_replace:^1.3 \
    drupal/node_read_time:^1.11 \
    # drupal/addtoany:^2.0.1 \
    drupal/addtoany:2.0.4 \
    drupal/views_ajax_history:^1.7 \
    drupal/select2:^1.15 \
    drupal/select2_multicheck:^1.0 \
    drupal/conditional_fields:^4.0@alpha
    # drupal/estimated_read_time:^1.0
    # drupal/taxonomy_import:^2.0.11 \
    # drupal/taxonomy_multidelete_terms:^1.3 \

# Copy project files from host
COPY $ROOT/drupal.sh ./
# COPY $ROOT/docker-php-entrypoint /usr/local/bin/
# RUN chmod +x /usr/local/bin/docker-php-entrypoint
COPY $ROOT/src/.htaccess ./web/
COPY $ROOT/src/robots.txt ./web/
COPY $ROOT/config/php.ini-$ENV /usr/local/etc/php/php.ini

# TODO: run drupal.sh --install
# CMD ["sh", "-c", "drupal.sh --install"]
# CMD ["bash /opt/drupal/drupal.sh --install"]
# CMD ["pwd && ls -la"]
# ENTRYPOINT ["pwd"]
# ENTRYPOINT ["bash /opt/drupal/drupal.sh --install"]
# ENTRYPOINT ["bash /usr/local/bin/docker-php-entrypoint && cd /opt/drupal && bash drupal.sh --install"]
# ENTRYPOINT ["docker-php-entrypoint"]
